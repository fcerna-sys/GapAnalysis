<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GapAnalysis</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0b0c0f; --panel:#121318; --fg:#fff; --muted:#a3a3a3; --primary:#7c3aed; --accent:#22c55e }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 600px at 10% 0%, #131524 0, #0b0c0f 50%, #0b0c0f 100%);color:var(--fg);font-family:'Inter',system-ui}
    .container{width:min(920px,92%);margin:0 auto;padding:32px}
    .hero{padding:56px 0}
    .hero .brand{display:inline-block;padding:8px 12px;border:1px solid #262a3a;border-radius:999px;color:#a3a3a3;font-size:12px}
    .hero h1{font-size:44px;line-height:1.05;margin:16px 0;background:linear-gradient(90deg,#fff,#cbd5e1);-webkit-background-clip:text;background-clip:text;color:transparent}
    .hero p{color:#a3a3a3;font-size:16px;max-width:720px}
    .actions{display:flex;gap:12px;margin-top:20px}
    .button{background:var(--primary);color:#fff;border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-block}
    .button.secondary{background:#1f2330;color:#fff;border:1px solid #2a3145}
    .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:24px}
    .card{background:var(--panel);border:1px solid #1f2330;border-radius:16px;padding:24px}
    h2{margin:0 0 12px;font-size:18px}
    p{color:var(--muted)}
    form{margin-top:16px;display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    input[type=file]{flex:1}
    input[type=text]{flex:1;padding:10px;border-radius:12px;border:1px solid #1f2330;color:#fff;background:#0b0c0f}
    button{background:var(--accent);color:#000;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  </style>
  <meta name="description" content="Convierte un ZIP de im√°genes en HTML base para un tema de WordPress" />
</head>
<body>
  <div class="container">
    <section class="hero">
      <span class="brand">GapAnalysis</span>
      <h1>Clonaci√≥n visual extrema de dise√±os a WordPress FSE</h1>
      <p>Convierte un ZIP con im√°genes en un tema FSE que replica proporciones, colores, micro‚Äëespaciados y patrones visuales. Con soporte para IA, slicing preciso y paleta DNA.</p>
      <div class="actions">
        <a class="button" href="#upload">Empezar</a>
        <a class="button secondary" href="/wp_theme/" target="_blank">Explorar tema</a>
      </div>
    </section>
    {% if env %}
    <div class="card" style="margin-bottom:16px">
      <h2 style="font-size:18px;margin:0 0 8px">Estado de entorno</h2>
      <ul style="list-style:none;padding:0;margin:0;color:#a3a3a3">
        <li>Modelo local (LM Studio / Ollama): 
          {% if env.local %}
            OK{% if env.local_names and env.local_names|length > 0 %} ‚Äî {{ env.local_names|join(', ') }}{% endif %}
          {% else %}
            No configurado
          {% endif %}
        </li>
        <li>Gemini (opcional): {{ 'OK' if env.gemini else 'Falta clave' }}</li>
        <li>OpenAI (opcional): {{ 'OK' if env.openai else 'Falta clave' }}</li>
        <li>Vision JSON (opcional): {% if env.vision_path %}{{ env.vision_path }}{% else %}No configurado{% endif %} ‚Äî {% if env.vision_valid %}V√°lido{% elif env.vision_exists %}No v√°lido{% else %}No existe{% endif %}</li>
        <li>Ollama endpoint (si usas Ollama): {{ env.ollama_endpoint }}</li>
      </ul>
    </div>
    {% endif %}
    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <div class="card" style="margin-bottom:16px">
      <ul>
        {% for m in messages %}
        <li>{{ m }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
    {% endwith %}
    <div class="card" id="upload">
      <h2>Configuraci√≥n del Tema</h2>
      <p>Configura los datos b√°sicos del tema y sube el ZIP con las im√°genes del dise√±o.</p>
      <form action="/upload" method="post" enctype="multipart/form-data" id="theme-form">
        <!-- Informaci√≥n del Tema -->
        <div style="margin-bottom:24px;padding-bottom:24px;border-bottom:1px solid #1f2330">
          <h3 style="font-size:16px;margin:0 0 16px;color:#fff;font-weight:600">Informaci√≥n del Tema</h3>
          
          <!-- Nombre del Tema (Obligatorio) -->
          <div style="margin-bottom:16px">
            <label style="display:block;margin-bottom:8px;color:#a3a3a3;font-weight:600">Nombre del Tema <span style="color:#ef4444">*</span></label>
            <input type="text" name="theme_name" placeholder="Ej: Mi Tema Personalizado" value="Img2HTML AI Theme" required style="width:100%;padding:10px;border-radius:12px;border:1px solid #1f2330;color:#fff;background:#0b0c0f;font-family:inherit" />
            <p style="font-size:12px;color:#6b7280;margin:4px 0 0">Este ser√° el nombre visible del tema en WordPress</p>
          </div>
          
          <!-- Slug del Tema (Auto-generado) -->
          <div style="margin-bottom:16px">
            <label style="display:block;margin-bottom:8px;color:#a3a3a3;font-weight:600">Slug del Tema (Auto-generado)</label>
            <input type="text" name="theme_slug" placeholder="Se genera autom√°ticamente desde el nombre" value="" id="theme-slug-input" style="width:100%;padding:10px;border-radius:12px;border:1px solid #1f2330;color:#fff;background:#0b0c0f;font-family:inherit" />
            <p style="font-size:12px;color:#6b7280;margin:4px 0 0">Identificador √∫nico del tema. Se genera autom√°ticamente si est√° vac√≠o</p>
          </div>
          
          <!-- Descripci√≥n del Tema -->
          <div style="margin-bottom:16px">
            <label style="display:block;margin-bottom:8px;color:#a3a3a3;font-weight:600">Descripci√≥n del Tema</label>
            <textarea name="theme_description" placeholder="Ej: Tema moderno generado desde im√°genes con dise√±o responsivo" style="width:100%;padding:10px;border-radius:12px;border:1px solid #1f2330;color:#fff;background:#0b0c0f;min-height:80px;font-family:inherit;resize:vertical">Tema de bloques generado y refinado con IA desde im√°genes</textarea>
            <p style="font-size:12px;color:#6b7280;margin:4px 0 0">Descripci√≥n breve que aparecer√° en el administrador de WordPress</p>
          </div>
          
          <!-- Foto del Tema (Screenshot) -->
          <div style="margin-bottom:16px">
            <label style="display:block;margin-bottom:8px;color:#a3a3a3;font-weight:600">Foto del Tema (Screenshot) <span style="color:#22c55e">Opcional</span></label>
            <div style="padding:12px;background:#0b0c0f;border-radius:8px;border:1px solid #1f2330;margin-bottom:8px">
              <p style="font-size:13px;color:#a3a3a3;margin:0 0 8px;line-height:1.5">
                <strong style="color:#fff">üì∏ Si no subes una foto:</strong> Se generar√° autom√°ticamente un SVG basado en el dise√±o analizado.
              </p>
              <p style="font-size:12px;color:#6b7280;margin:0;line-height:1.5">
                <strong>Recomendado:</strong> 1200x900px (PNG, JPG, WebP o SVG). Esta imagen aparecer√° como portada del tema en WordPress.
              </p>
            </div>
            <input type="file" name="theme_screenshot" accept="image/png,image/jpeg,image/jpg,image/webp,image/svg+xml" id="screenshot-input" style="width:100%;padding:10px;border-radius:12px;border:1px solid #1f2330;color:#fff;background:#0b0c0f;cursor:pointer" />
            <div id="screenshot-preview" style="display:none;margin-top:12px;padding:16px;background:#0b0c0f;border-radius:12px;border:1px solid #1f2330;text-align:center">
              <p style="font-size:12px;color:#a3a3a3;margin:0 0 12px">Vista previa:</p>
              <img id="preview-img" src="" alt="Preview del screenshot" style="max-width:100%;max-height:200px;border-radius:8px;display:block;margin:0 auto;box-shadow:0 4px 12px rgba(0,0,0,0.3)" />
              <button type="button" onclick="clearScreenshot()" style="margin-top:12px;padding:8px 16px;background:#ef4444;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">üóëÔ∏è Eliminar Foto</button>
            </div>
          </div>
          
          <!-- Versi√≥n, Autor y URL -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
            <div>
              <label style="display:block;margin-bottom:8px;color:#a3a3a3;font-weight:600;font-size:13px">Versi√≥n</label>
              <input type="text" name="theme_version" placeholder="1.0.0" value="1.0.0" style="width:100%;padding:10px;border-radius:12px;border:1px solid #1f2330;color:#fff;background:#0b0c0f;font-family:inherit" />
            </div>
            <div>
              <label style="display:block;margin-bottom:8px;color:#a3a3a3;font-weight:600;font-size:13px">Autor</label>
              <input type="text" name="theme_author" placeholder="Tu nombre o empresa" value="" style="width:100%;padding:10px;border-radius:12px;border:1px solid #1f2330;color:#fff;background:#0b0c0f;font-family:inherit" />
            </div>
          </div>
          
          <!-- URL del Tema y Text Domain -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
            <div>
              <label style="display:block;margin-bottom:8px;color:#a3a3a3;font-weight:600;font-size:13px">URL del Tema</label>
              <input type="url" name="theme_uri" placeholder="https://ejemplo.com/tema" value="" style="width:100%;padding:10px;border-radius:12px;border:1px solid #1f2330;color:#fff;background:#0b0c0f;font-family:inherit" />
            </div>
            <div>
              <label style="display:block;margin-bottom:8px;color:#a3a3a3;font-weight:600;font-size:13px">Text Domain</label>
              <input type="text" name="theme_textdomain" placeholder="Auto-generado desde slug" value="" id="theme-textdomain-input" style="width:100%;padding:10px;border-radius:12px;border:1px solid #1f2330;color:#fff;background:#0b0c0f;font-family:inherit" />
            </div>
          </div>
          
          <!-- Tags y Licencia -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <label style="display:block;margin-bottom:8px;color:#a3a3a3;font-weight:600;font-size:13px">Tags (separados por comas)</label>
              <input type="text" name="theme_tags" placeholder="blog, business, portfolio" value="" style="width:100%;padding:10px;border-radius:12px;border:1px solid #1f2330;color:#fff;background:#0b0c0f;font-family:inherit" />
            </div>
            <div>
              <label style="display:block;margin-bottom:8px;color:#a3a3a3;font-weight:600;font-size:13px">Licencia</label>
              <select name="theme_license" style="width:100%;padding:10px;border-radius:12px;border:1px solid #1f2330;color:#fff;background:#0b0c0f;font-family:inherit;cursor:pointer">
                <option value="GPLv2 or later">GPLv2 or later</option>
                <option value="GPLv3 or later">GPLv3 or later</option>
                <option value="MIT">MIT</option>
                <option value="Proprietary">Proprietary</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Framework CSS -->
        <div style="margin-bottom:24px;padding-bottom:24px;border-bottom:1px solid #1f2330">
          <label style="display:block;margin-bottom:8px;color:#a3a3a3;font-weight:600">Framework CSS (obligatorio):</label>
          <label style="display:flex;align-items:center;gap:8px;color:#a3a3a3;margin-bottom:8px">
            <input type="radio" name="css_framework" value="tailwind" checked />
            Tailwind CSS
          </label>
          <label style="display:flex;align-items:center;gap:8px;color:#a3a3a3;margin-bottom:8px">
            <input type="radio" name="css_framework" value="bootstrap" />
            Bootstrap 5
          </label>
          <label style="display:flex;align-items:center;gap:8px;color:#a3a3a3;margin-bottom:8px">
            <input type="radio" name="css_framework" value="none" />
            Ninguno (CSS propio)
          </label>
        </div>
        
        <!-- Archivos -->
        <div style="margin-bottom:24px">
          <h3 style="font-size:16px;margin:0 0 16px;color:#fff;font-weight:600">Archivos</h3>
          <label style="display:block;margin-bottom:8px;color:#a3a3a3;font-weight:600">ZIP de im√°genes (obligatorio):</label>
          <input type="file" name="zipfile" accept=".zip" required style="width:100%;padding:10px;border-radius:12px;border:1px solid #1f2330;color:#fff;background:#0b0c0f;margin-bottom:8px" />
          <p style="font-size:12px;color:#6b7280;margin:0;line-height:1.5">
            Consejo: puedes incluir tambi√©n tus <strong>fuentes personalizadas</strong> en el mismo ZIP
            (<code>.ttf</code>, <code>.otf</code>, <code>.woff</code>, <code>.woff2</code>). La app las copiar√° al tema
            e intentar√° registrarlas en <code>theme.json</code> para que aparezcan como familias tipogr√°ficas del tema.
          </p>
        </div>
        
        <!-- Configuraci√≥n Avanzada -->
        <details style="margin-bottom:24px">
          <summary style="cursor:pointer;color:#a3a3a3;font-weight:600;padding:12px;background:#0b0c0f;border-radius:8px;border:1px solid #1f2330">Configuraci√≥n Avanzada (Opcional)</summary>
          <div style="padding:16px;background:#0b0c0f;border-radius:8px;margin-top:8px;border:1px solid #1f2330">
            <div style="margin-bottom:12px">
              <label style="display:block;margin-bottom:8px;color:#a3a3a3;font-weight:600">Google Vision API:</label>
              <input type="text" name="google_api_key" placeholder="GOOGLE_API_KEY (opcional)" style="width:100%;padding:10px;border-radius:12px;border:1px solid #1f2330;color:#fff;background:#0b0c0f;margin-bottom:8px;font-family:inherit" />
              <input type="text" name="google_application_credentials" placeholder="Ruta a GOOGLE_APPLICATION_CREDENTIALS (opcional)" style="width:100%;padding:10px;border-radius:12px;border:1px solid #1f2330;color:#fff;background:#0b0c0f;margin-bottom:8px;font-family:inherit" />
              <input type="file" name="google_application_credentials_file" accept=".json" style="width:100%;padding:10px;border-radius:12px;border:1px solid #1f2330;color:#fff;background:#0b0c0f;font-family:inherit" />
            </div>
            <div style="margin-top:16px">
              <label style="display:flex;align-items:center;gap:8px;color:#a3a3a3;margin-bottom:8px">
                <input type="checkbox" name="save_env" checked /> Guardar credenciales en .env
              </label>
              <label style="display:flex;align-items:center;gap:8px;color:#a3a3a3;margin-bottom:8px">
                <input type="checkbox" name="enable_slicing" /> Slicing experimental (requiere rembg)
              </label>
              <label style="display:flex;align-items:center;gap:8px;color:#a3a3a3;margin-bottom:8px">
                <input type="checkbox" name="precise_slicing" /> Slicing preciso (OpenCV)
              </label>
              <label style="display:flex;align-items:center;gap:8px;color:#a3a3a3;margin-bottom:8px">
                <input type="checkbox" name="enable_seo" /> Aplicar SEO b√°sico (meta title/description, Open Graph, alt en im√°genes)
              </label>
            </div>
          </div>
        </details>
        
        <button type="submit" style="width:100%;padding:14px;background:var(--accent);color:#000;border:none;border-radius:12px;font-weight:700;cursor:pointer;font-size:16px">Analizar ZIP y Generar Tema</button>
      </form>
    </div>
    
    <!-- Fase 2: Mejorar un tema existente desde HTML + Theme (opcional) -->
    <div class="card" style="margin-top:16px">
      <h2>Mejorar un tema existente desde HTML refinado</h2>
      <p>Si ya descargaste el bundle (HTML + tema WP), puedes editar el HTML, volver a comprimirlo en un ZIP (idealmente manteniendo las carpetas <code>html/</code> y <code>theme/</code>) y subirlo aqu√≠. La app regenerar√° el tema usando ese HTML refinado como fuente principal.</p>
      <form action="/refine_theme_from_html" method="post" enctype="multipart/form-data" style="margin-top:16px">
        <label style="display:block;margin-bottom:8px;color:#a3a3a3;font-weight:600">ZIP con HTML refinado (y opcionalmente carpeta theme/):</label>
        <input type="file" name="html_zip" accept=".zip" required style="width:100%;padding:10px;border-radius:12px;border:1px solid #1f2330;color:#fff;background:#0b0c0f;margin-bottom:16px" />
        <button type="submit" style="width:100%;padding:12px;background:var(--primary);color:#fff;border:none;border-radius:12px;font-weight:700;cursor:pointer;font-size:15px">Subir ZIP y mejorar tema existente</button>
      </form>
    </div>
  </div>
  
  <script>
    // Funci√≥n para limpiar screenshot
    function clearScreenshot() {
      document.getElementById('screenshot-input').value = '';
      document.getElementById('screenshot-preview').style.display = 'none';
      document.getElementById('preview-img').src = '';
    }
    
    // Preview de screenshot
    document.getElementById('screenshot-input').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        // Validar tama√±o (m√°x 5MB)
        if (file.size > 5 * 1024 * 1024) {
          alert('La imagen es demasiado grande. M√°ximo 5MB.');
          this.value = '';
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.getElementById('screenshot-preview');
          const img = document.getElementById('preview-img');
          img.src = e.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        clearScreenshot();
      }
    });
    
    // Auto-generar slug y textdomain desde nombre
    const themeNameInput = document.querySelector('input[name="theme_name"]');
    const slugInput = document.getElementById('theme-slug-input');
    const textdomainInput = document.getElementById('theme-textdomain-input');
    
    function generateSlug(text) {
      return text
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
    }
    
    themeNameInput.addEventListener('input', function(e) {
      if (!slugInput.value || slugInput.dataset.autoGenerated === 'true') {
        const slug = generateSlug(e.target.value);
        slugInput.value = slug;
        slugInput.dataset.autoGenerated = 'true';
        
        // Auto-generar textdomain tambi√©n
        if (!textdomainInput.value || textdomainInput.dataset.autoGenerated === 'true') {
          textdomainInput.value = slug;
          textdomainInput.dataset.autoGenerated = 'true';
        }
      }
    });
    
    // Permitir edici√≥n manual del slug
    slugInput.addEventListener('input', function(e) {
      if (e.target.value) {
        e.target.dataset.autoGenerated = 'false';
        // Actualizar textdomain si tambi√©n est√° auto-generado
        if (textdomainInput.dataset.autoGenerated === 'true') {
          textdomainInput.value = e.target.value;
        }
      }
    });
    
    // Auto-generar textdomain desde slug
    slugInput.addEventListener('input', function(e) {
      if (!textdomainInput.value || textdomainInput.dataset.autoGenerated === 'true') {
        textdomainInput.value = e.target.value;
        textdomainInput.dataset.autoGenerated = 'true';
      }
    });
    
    // Permitir edici√≥n manual del textdomain
    textdomainInput.addEventListener('input', function(e) {
      if (e.target.value) {
        e.target.dataset.autoGenerated = 'false';
      }
    });
    
    // Validaci√≥n del formulario
    document.getElementById('theme-form').addEventListener('submit', function(e) {
      const themeName = themeNameInput.value.trim();
      if (!themeName) {
        e.preventDefault();
        alert('Por favor, ingresa un nombre para el tema.');
        themeNameInput.focus();
        return false;
      }
      
      // Validar slug si fue ingresado manualmente
      const slug = slugInput.value.trim();
      if (slug && !/^[a-z0-9-]+$/.test(slug)) {
        e.preventDefault();
        alert('El slug solo puede contener letras min√∫sculas, n√∫meros y guiones.');
        slugInput.focus();
        return false;
      }
    });
  </script>
</body>
</html>